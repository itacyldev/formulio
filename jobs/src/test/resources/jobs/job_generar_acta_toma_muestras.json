{
  "description": "Job Acta Muestras",
  "requiredContexts": [
    "user",
    "job"
  ],
  "globalParams": {
    "endpoint": "https://serviciosdes.itacyl.es/uqserv/cnt/rest/files/",
    "apikey": "USER-MUNGARRO-UQSERV",
    "jobType": "FormicGenerarActaTomaMuestra",
    "endpointActa": "https://serviciosdes.itacyl.es/uqserv/cnt/rest/jobs/"
  },
  "executionMode": "FG",
  "tasks": [
    {
      "name": "t1",
      "reader": {
        "type": "sqlreader",
        "dbFile": "${params.dbFile}",
        "sqlQuery": "SELECT acta_toma_muestra.acta_id ACTA_ID, acta_toma_muestra.acta ACTA, formato || ' ' || revision FORMATO, operador.razon_social RAZON_SOCIAL, operador.tipo_via_operador || ' ' || operador.via_operador || ' ' || localidad_operador.d_exten_loca || ', ' || provincia_operador.d_exten_prov || ' ' || operador.codigo_postal_operador || '-' || operador.pais DOMICILIO_SOCIAL, operador.direccion_instalacion || ' ' || localidad_instalacion.d_exten_loca || ', ' || provincia_instalacion.d_exten_prov || ' ' || operador.codigo_postal_instalacion || '-' || operador.pais DIRECCION_INSTALACION, operador.nif_operador NIF_OPERADOR, operador.nif_representante NIF_REPRESENTANTE, operador.nombre_representante || ' ' || apellidos_representante NOMBRE_REPRESENTANTE, acta_toma_muestra.nombre_toma_muestra NOMBRE, acta_toma_muestra.apellidos_toma_muestra APELLIDOS, acta_toma_muestra.dni_toma_muestra DNI, acta_toma_muestra.operador_renuncia OPERADOR_RENUNCIA, acta_toma_muestra.entrega_inspeccionado ENTREGA_INSPECCIONADO, acta_toma_muestra.observaciones_entrega_inspeccionado OBSERVACIONES_ENTREGA_INSPECCIONADO, 'A ' || strftime('%d',acta_toma_muestra.fecha_firma) || ' de ' || case strftime('%m',acta_toma_muestra.fecha_firma) when '01' then 'enero' when '02' then 'febrero' when '03' then 'marzo' when '04' then 'abril' when '05' then 'mayo' when '06' then 'junio' when '07' then 'julio' when '08' then 'agosto' when '09' then 'septiembre' when '10' then 'octubre' when '11' then 'noviembre' when '12' then 'diciembre' end || ' de ' || strftime('%Y',acta_toma_muestra.fecha_firma) FECHA_FIRMA, acta_toma_muestra.auditor AUDITOR, acta_toma_muestra.auditor2 AUDITOR2, acta_toma_muestra.auditado AUDITADO FROM acta_toma_muestra LEFT OUTER JOIN expediente ON acta_toma_muestra.expediente_id = expediente.expediente_id LEFT OUTER JOIN operador ON expediente.operador_id = operador.operador_id LEFT OUTER JOIN comu_localidad_21 localidad_operador ON operador.localidad_operador_id = localidad_operador.c_localidad_id LEFT OUTER JOIN comu_provincia provincia_operador ON operador.provincia_operador_id = provincia_operador.c_provincia LEFT OUTER JOIN comu_localidad_21 localidad_instalacion ON operador.localidad_instalacion_id = localidad_instalacion.c_localidad_id LEFT OUTER JOIN comu_provincia provincia_instalacion ON operador.provincia_instalacion_id = provincia_instalacion.c_provincia WHERE acta_toma_muestra.expediente_id='${params.expediente_id}'"
      },
      "writer": {
        "type": "csvWriter",
        "outputFile": "cabecera.csv"
      }
    },
    {
      "name": "t2",
      "processor": {
        "inputFile": "${t1.outputFile}",
        "type": "httpRequestProcessor",
        "method": "post",
        "headers": {
          "Content-Type": "multipart/form-data",
          "Accept": "multipart/form-data"
        },
        "url": "${gparams.endpoint}?jobType=${gparams.jobType}&apikey=${gparams.apikey}"
      }
    },
    {
      "name": "t3",
      "reader": {
        "type": "sqlreader",
        "dbFile": "${params.dbFile}",
        "sqlQuery": "SELECT muestra, tipo_muestra, dispuesta_comercializacion, denominacion_venta, marca_comercial, lote, fecha_consumo_preferente, num_contraetiqueta, cantidad_producto_muestreado, id_muestra_inicial, id_muestra_contradictorio, id_muestra_dirimente, tipo_deteminaciones FROM muestra LEFT JOIN acta_toma_muestra ON muestra.acta_id = acta_toma_muestra.acta_id WHERE acta_toma_muestra.expediente_id='${params.expediente_id}'"
      },
      "writer": {
        "type": "csvWriter",
        "outputFile": "muestras.csv"
      }
    },
    {
      "name": "t4",
      "processor": {
        "inputFile": "${t3.outputFile}",
        "type": "httpRequestProcessor",
        "method": "post",
        "headers": {
          "Content-Type": "multipart/form-data",
          "Accept": "multipart/form-data"
        },
        "url": "${gparams.endpoint}?jobType=${gparams.jobType}&apikey=${gparams.apikey}"
      }
    },
    {
      "name": "t5",
      "processor": {
        "type": "httpRequestProcessor",
        "method": "post",
        "url": "${gparams.endpointActa}?jobType=${gparams.jobType}&apikey=${gparams.apikey}&inputFile=${t2.responseHeaders['Location']}&inputFile=${t4.responseHeaders['Location']}"
      }
    },
    {
      "name": "t6",
      "processor": {
        "type": "httpRequestProcessor",
        "method": "get",
        "url": "${t5.responseHeaders['Location']}?apikey=${gparams.apikey}"
      }
    },
    {
      "name": "t7",
      "processor": {
        "type": "httpRequestProcessor",
        "method": "get",
        "url": "${t6.outputJson['resources'][0]}?apikey=${gparams.apikey}",
        "outputFile": "Acta_Toma_Muestras.docx",
        "outputFileExtension": "docx"
      }
    }
  ]
}