
pipeline {
    agent any

    parameters {
            choice(name: 'ENV_TYPE', choices: ['alpha', 'beta', 'production' ], description: 'Canal de despliegue')
            string(name: 'BRANCH_TO_DEPLOY', defaultValue: "develop", description: 'GIT branch to deploy')
            string(name: 'RELEASE_DESCRIPTION', defaultValue: "", description: 'Descripcion para la etiqueta (sin version ni fecha), si no pones nada la etiqueta tendr√° el formato v1.0.0_yyyymmdd')
    }

    environment {
        PROJECT_NAME = 'FRMDRD'
        GIT_URL = "https://servicios.itacyl.es/gitea/ITACyL/${PROJECT_NAME}.git"
    }

    stages {
         stage('Setup Tools') {
            steps{
                script {
                    withCredentials([file(credentialsId: 'android_keystore', variable: 'KEYFILE')]) {
                        sh "cp \$KEYFILE app/keystore"
                    }
                }
            }
        }

        stage("Merge, tag and push to master") {
            steps {
                echo " The environment is ${params.ENV_TYPE}"
                script {
                    def now = new Date()
                    def version_value = sh(returnStdout: true, script: "cat build.gradle | grep -o 'versionName = [^,]*'").trim()
                    sh "echo Project in version value: $version_value"
                    def VERSION = version_value.split(/=/)[1].trim().replaceAll("'","")
                    sh "echo final version: VERSION"
                    def TIMESTAMP = now.format("yyyyMMdd")
                    def DESC = ""
                    if(params.RELEASE_DESCRIPTION){
                        DESC = "_${params.RELEASE_DESCRIPTION}".replaceAll(" ","_")
                    }
                    def ENV = ""
                    if(params.ENV_TYPE != 'production'){
                        ENV = "_${params.ENV_TYPE}"
                    }
                    RELEASE_TAG = "v${VERSION}_${TIMESTAMP}${DESC}${ENV}"
                }
                echo "Etiquetando version ${RELEASE_TAG}"
           }
        }
   }
    //post {
        //failure {
        //    emailext body: '''${SCRIPT, template="groovy-html.template"}''',
        //    recipientProviders: [culprits()],
        //    subject: "Build failed in jenkins: ${env.JOB_NAME} ${env.BUILD_NUMBER}",
        //    mimeType: 'text/html'
       // }
    //}
}