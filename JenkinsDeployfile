
pipeline {
    agent any

    environment {
        PROJECT_NAME = 'FRMDRD'
        GIT_URL = "https://servicios.itacyl.es/gitea/ITACyL/${PROJECT_NAME}.git"
    }

    stages {
         stage('Setup Tools') {
            steps{
                script {
                    withCredentials([file(credentialsId: 'android_keystore', variable: 'KEYFILE')]) {
                        sh "cp \$KEYFILE app/keystore"
                    }
                }
            }
        }

        stage("Build Apk") {
            steps{
                script {
                    withCredentials([file(credentialsId: 'android_keystore', variable: 'KEYFILE')]) {
                        sh """
                            chmod +x gradlew
                            ./gradlew clean assembleRelease
                        """
                    }
                }
            }
        }

        stage('Upload to Play Store') {
            steps{
                // Archive the APKs so that they can be downloaded from Jenkins
                archiveArtifacts '**/build/outputs/**/*.apk'

                // Upload the APK to Google Play
                androidApkUpload googleCredentialsId: 'Google Play Key', apkFilesPattern: '**/build/outputs/**/*.apk', trackName: 'alpha',  rolloutPercentage: '100'

            }
        }
   }
    //post {
        //failure {
        //    emailext body: '''${SCRIPT, template="groovy-html.template"}''',
        //    recipientProviders: [culprits()],
        //    subject: "Build failed in jenkins: ${env.JOB_NAME} ${env.BUILD_NUMBER}",
        //    mimeType: 'text/html'
       // }
    //}
}