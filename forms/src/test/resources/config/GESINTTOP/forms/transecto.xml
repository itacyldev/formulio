<main id="idTransecto" name="Transecto" repo="transectoRepo" mainForm="false">
    <list id="listTransecto"/>
    <edit id="editTransecto">
        <script src="scripts/control.js"/>
        <form id="formTransecto">

            <p value=""/>
            <p backgroundColor="#26a69a" fontSize="22" fontColor="#FFFFFF" bold="true" value="TRANSECTO"/>
            <p value=""/>

            <table>
                <row>
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Visita"/>
                </row>
                <row weights="20, 40, 40">
                    <input id="visita_id" label="Id. visita: " readonly="true" value="${entity.visita_id}" />
                    <input label="Visita: " value="${entity.visita.visita}" readonly="true"/>
                    <date label="Fecha evaluación: " value="${entity.visita.fecha_evaluacion}" readonly="true"/>
                </row>
            </table>

            <table>
                <row>
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Transecto"/>
                </row>
                <row weights="20, 40, 40">
                    <input label="Nº transecto: " value="${entity.num_transecto}" validator="required"/>
                    <autocomplete label="Tipo transecto: " forceSelection="true" id="tipo_transecto_id" repo="tipoTransectoRepo" value="${entity.tipo_transecto_id}" validator="required">
                        <options labelExpression="${entity.tipo_transecto}" labelFilteringProperty="tipo_transecto" valueProperty="tipo_transecto_id" />
                        <repofilter>
                            <contains property="tipo_transecto" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <input label="Nº uds. muestrales: " id="num_unidades_muestrales_transecto" value="${entity.num_unidades_muestrales_transecto}" readonly="true" allowsPartialRestore="false"/>
                    <input label="Prefijo GPS: " value="${entity.prefijo_gps}" readonly="true" />
                 </row>
            </table>

            <table weights="6, 15, 16, 14, 12, 13, 14, 12">
                <row>
                    <p backgroundColor="#B1B1B1" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Relleno automático"/>
                </row>
                <row>
                    <p value=""/>
                    <autocomplete label="Huras totales: " forceSelection="true" repo="hurasTotalesTransectoRepo" id="hurasTotalesAutomatico" >
                        <options labelExpression="${entity.d_huras_totales_transecto}" labelFilteringProperty="d_huras_totales_transecto" valueProperty="c_huras_totales_transecto_id" />
                        <repofilter>
                            <and>
                                <contains property="d_huras_totales_transecto" value="${this.value}"/>
                            </and>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Huras activas: " forceSelection="true" repo="hurasActivasTransectoRepo" id="hurasActivasAutomatico">
                        <options labelExpression="${entity.d_huras_activas_transecto}" labelFilteringProperty="d_huras_activas_transecto" valueProperty="c_huras_activas_transecto_id" />
                        <repofilter>
                            <and>
                                <contains property="d_huras_activas_transecto" value="${this.value}"/>
                            </and>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Densidad: " forceSelection="true" repo="densidadCubiertaTransectoRepo" id="densidadCubiertaAutomatico">
                        <options labelExpression="${entity.d_densidad_cubierta_transecto}" labelFilteringProperty="d_densidad_cubierta_transecto" valueProperty="c_densidad_cubierta_transecto_id" />
                        <repofilter>
                            <and>
                                <contains property="d_densidad_cubierta_transecto" value="${this.value}"/>
                            </and>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="% daño: " forceSelection="true" repo="porcentajeDanoTransectoRepo" id="porcentajeDanoAutomatico">
                        <options labelExpression="${entity.d_porcentaje_dano_transecto}" labelFilteringProperty="d_porcentaje_dano_transecto" valueProperty="c_porcentaje_dano_transecto_id" />
                        <repofilter>
                            <and>
                                <contains property="d_porcentaje_dano_transecto" value="${this.value}"/>
                            </and>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Trampas: " forceSelection="true" repo="presenciaTrampasTransectoRepo" id="trampasAutomatico">
                        <options labelExpression="${entity.d_presencia_trampas_transecto}" labelFilteringProperty="d_presencia_trampas_transecto" valueProperty="c_presencia_trampas_transecto_id" />
                        <repofilter>
                            <and>
                                <contains property="d_presencia_trampas_transecto" value="${this.value}"/>
                            </and>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Caminillos: " forceSelection="true" repo="caminillosTransectoRepo" id="caminillosAutomatico">
                        <options labelExpression="${entity.d_caminillos_transecto}" labelFilteringProperty="d_caminillos_transecto" valueProperty="c_caminillos_transecto_id" />
                        <repofilter>
                            <and>
                                <contains property="d_caminillos_transecto" value="${this.value}"/>
                            </and>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Altura: " forceSelection="true" repo="alturaCubiertaTransectoRepo" id="alturaCubiertaAutomatico">
                        <options labelExpression="${entity.d_altura_cubierta_transecto}" labelFilteringProperty="d_altura_cubierta_transecto" valueProperty="c_altura_cubierta_transecto_id" />
                        <repofilter>
                            <and>
                                <contains property="d_altura_cubierta_transecto" value="${this.value}"/>
                            </and>
                        </repofilter>
                    </autocomplete>
                </row>
            </table>

            <button label="APLICAR RELLENO AUTOMÁTICO">
                    <action type="js" controller="datalistUnidadMuestral">
                        <param name="method" value="aplicarRellenoAutomatico" />
                        <param name="entityId" value="${entity.transecto_id}"/>
                        <param name="hurasTotalesAutomatico" value="${view.hurasTotalesAutomatico}" />
                        <param name="hurasActivasAutomatico" value="${view.hurasActivasAutomatico}" />
                        <param name="densidadCubiertaAutomatico" value="${view.densidadCubiertaAutomatico}" />
                        <param name="porcentajeDanoAutomatico" value="${view.porcentajeDanoAutomatico}" />
                        <param name="trampasAutomatico" value="${view.trampasAutomatico}" />
                        <param name="caminillosAutormatico" value="${view.caminillosAutomatico}" />
                        <param name="alturaCubiertaAutomatico" value="${view.alturaCubiertaAutomatico}" />
                    </action>
                </button>


            <table weights="6, 15, 16, 14, 12, 13, 14, 12">
                <row>
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Unidades muestrales"/>
                </row>
            </table>


            <datalist id="datalistUnidadMuestral" repo="unidadMuestralRepo" allowsPartialRestore="false">
                <repofilter>
                    <eq property="transecto_id" value="${entity.transecto_id}"/>
                </repofilter>
                <datalistitem id="datalistitemUnidadMuestral">
                    <table weights="6, 15, 16, 14, 12, 13, 14, 12">
                        <row>
                            <input id="num_unidad_muestral" value="${math:round(entity.num_unidad_muestral)}" readonly="true"/>
                            <autocomplete converter="long" label="Huras totales: " id="c_huras_totales_transecto_id" forceSelection="true" repo="hurasTotalesTransectoRepo" value="${entity.c_huras_totales_transecto_id}" >
                                <options labelExpression="${entity.d_huras_totales_transecto}" labelFilteringProperty="d_huras_totales_transecto" valueProperty="c_huras_totales_transecto_id" />
                                <repofilter>
                                    <and>
                                        <contains property="d_huras_totales_transecto" value="${this.value}"/>
                                    </and>
                                </repofilter>
                                <action id="compositeActionHurasTotales">
                                    <action type="js">
                                        <param name="method" value="updateHurasActivas" />
                                        <param name="num_unidad_muestral" value="${view.num_unidad_muestral}" />
                                   </action>
                                    <action type="js">
                                        <param name="method" value="saveValorUnidadMuestral" />
                                        <param name="unidad_muestral_id" value="${entity.unidad_muestral_id}" />
                                        <param name="campo" value="c_huras_totales_transecto_id" />
                                        <param name="valor" value="${view.c_huras_totales_transecto_id}" />
                                    </action>
                              </action>
                            </autocomplete>
                            <autocomplete converter="long" label="Huras activas: " id="c_huras_activas_transecto_id"  forceSelection="true" repo="hurasActivasTransectoRepo"  value="${entity.c_huras_activas_transecto_id}" >
                                <options labelExpression="${entity.d_huras_activas_transecto}" labelFilteringProperty="d_huras_activas_transecto" valueProperty="c_huras_activas_transecto_id" />
                                <repofilter>
                                    <and>
                                        <contains property="d_huras_activas_transecto" value="${this.value}"/>
                                    </and>
                                </repofilter>
                                <action id="compositeActionHurasActivas">
                                    <action type="js">
                                        <param name="method" value="updateHurasTotales" />
                                        <param name="num_unidad_muestral" value="${view.num_unidad_muestral}" />
                                    </action>
                                    <action type="js">
                                        <param name="method" value="saveValorUnidadMuestral" />
                                        <param name="unidad_muestral_id" value="${entity.unidad_muestral_id}" />
                                        <param name="campo" value="c_huras_totales_transecto_id" />
                                        <param name="valor" value="${view.c_huras_totales_transecto_id}" />
                                    </action>
                                </action>
                            </autocomplete>
                            <autocomplete converter="long" label="Densidad: " id="c_densidad_cubierta_transecto_id" forceSelection="true" repo="densidadCubiertaTransectoRepo" value="${entity.c_densidad_cubierta_transecto_id}" >
                                <options labelExpression="${entity.d_densidad_cubierta_transecto}" labelFilteringProperty="d_densidad_cubierta_transecto" valueProperty="c_densidad_cubierta_transecto_id" />
                                <repofilter>
                                    <and>
                                        <contains property="d_densidad_cubierta_transecto" value="${this.value}"/>
                                    </and>
                                </repofilter>
                                <action type="js">
                                    <param name="method" value="saveValorUnidadMuestral" />
                                    <param name="unidad_muestral_id" value="${entity.unidad_muestral_id}" />
                                    <param name="campo" value="c_densidad_cubierta_transecto_id" />
                                    <param name="valor" value="${view.c_densidad_cubierta_transecto_id}" />
                                </action>
                            </autocomplete>
                            <autocomplete converter="long" label="% daño: " id="c_porcentaje_dano_transecto_id" forceSelection="true" repo="porcentajeDanoTransectoRepo" value="${entity.c_porcentaje_dano_transecto_id}" >
                                <options labelExpression="${entity.d_porcentaje_dano_transecto}" labelFilteringProperty="d_porcentaje_dano_transecto" valueProperty="c_porcentaje_dano_transecto_id" />
                                <repofilter>
                                    <and>
                                        <contains property="d_porcentaje_dano_transecto" value="${this.value}"/>
                                    </and>
                                </repofilter>
                                <action type="js">
                                    <param name="method" value="saveValorUnidadMuestral" />
                                    <param name="unidad_muestral_id" value="${entity.unidad_muestral_id}" />
                                    <param name="campo" value="c_porcentaje_dano_transecto_id" />
                                    <param name="valor" value="${view.c_porcentaje_dano_transecto_id}" />
                                </action>
                            </autocomplete>
                            <autocomplete converter="long" label="Trampas: " id="c_presencia_trampas_transecto_id" forceSelection="true" repo="presenciaTrampasTransectoRepo" value="${entity.c_presencia_trampas_transecto_id}" >
                                <options labelExpression="${entity.d_presencia_trampas_transecto}" labelFilteringProperty="d_presencia_trampas_transecto" valueProperty="c_presencia_trampas_transecto_id" />
                                <repofilter>
                                    <and>
                                        <contains property="d_presencia_trampas_transecto" value="${this.value}"/>
                                    </and>
                                </repofilter>
                                <action type="js">
                                    <param name="method" value="saveValorUnidadMuestral" />
                                    <param name="unidad_muestral_id" value="${entity.unidad_muestral_id}" />
                                    <param name="campo" value="c_presencia_trampas_transecto_id" />
                                    <param name="valor" value="${view.c_presencia_trampas_transecto_id}" />
                                </action>
                            </autocomplete>
                            <autocomplete converter="long" label="Caminillos: " id="c_caminillos_transecto_id" forceSelection="true" repo="caminillosTransectoRepo" value="${entity.c_caminillos_transecto_id}" >
                                <options labelExpression="${entity.d_caminillos_transecto}" labelFilteringProperty="d_caminillos_transecto" valueProperty="c_caminillos_transecto_id" />
                                <repofilter>
                                    <and>
                                        <contains property="d_caminillos_transecto" value="${this.value}"/>
                                    </and>
                                </repofilter>
                                <action type="js">
                                    <param name="method" value="saveValorUnidadMuestral" />
                                    <param name="unidad_muestral_id" value="${entity.unidad_muestral_id}" />
                                    <param name="campo" value="c_caminillos_transecto_id" />
                                    <param name="valor" value="${view.c_caminillos_transecto_id}" />
                                </action>
                            </autocomplete>
                            <autocomplete converter="long" label="Altura: " id="c_altura_cubierta_transecto_id" forceSelection="true" repo="alturaCubiertaTransectoRepo" value="${entity.c_altura_cubierta_transecto_id}" >
                                <options labelExpression="${entity.d_altura_cubierta_transecto}" labelFilteringProperty="d_altura_cubierta_transecto" valueProperty="c_altura_cubierta_transecto_id" />
                                <repofilter>
                                    <and>
                                        <contains property="d_altura_cubierta_transecto" value="${this.value}"/>
                                    </and>
                                </repofilter>
                                <action type="js">
                                    <param name="method" value="saveValorUnidadMuestral" />
                                    <param name="unidad_muestral_id" value="${entity.unidad_muestral_id}" />
                                    <param name="campo" value="c_altura_cubierta_transecto_id" />
                                    <param name="valor" value="${view.c_altura_cubierta_transecto_id}" />
                                </action>
                            </autocomplete>
                        </row>
                        <row>
                            <textarea id="observaciones_unidad_muestral" label="Observaciones" value="${entity.observaciones_unidad_muestral}"/>
                        </row>
                    </table>
                </datalistitem>
            </datalist>

            <button label="AÑADIR UNIDAD MUESTRAL">
                <action type="js" controller="datalistUnidadMuestral" refresh="datalistUnidadMuestral">
                    <param name="method" value="anadirUnidadMuestral" />
                    <param name="entityId" value="${entity.transecto_id}"/>
                </action>
            </button>


        </form>

        <buttonbar type="bottom">
            <button label="Save">
                <action type="save" route="back" registerInHistory="false" restoreView="true" controller="formTransecto, datalistUnidadMuestral">
                    <param name="entityId" value="${entity.visita_id}" />
                </action>
            </button>

            <button label="Cancel">
                <action type="cancel" route="back" restoreView="true">
                    <param name="entityId" value="${entity.visita_id}" />
                </action>
            </button>

            <button label="Delete" readonly="${empty (entity.transecto_id)}" readonlyMessage="No puede realizar esta acción: No existe el transecto" restoreView="true" confirmation="true" labelConfirmation="Se va a eliminar el transecto. ¿Desea continuar?">
                <!--action type="js" route="back" registerInHistory="false">
                    <param name="method" value="deleteTransecto" />
                    <param name="transectoId" value="${entity.transecto_id}" />
                    <param name="entityId" value="${entity.transecto_id}" />
                </action-->
                <action type="delete" route="back" registerInHistory="false">
                    <param name="entityId" value="${entity.visita_id}" />
                </action>
            </button>
        </buttonbar>
    </edit>
</main>
