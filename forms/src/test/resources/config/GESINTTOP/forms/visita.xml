<main name="visita" description="Visitas" id="idVisita" repo="visitaRepo">
    <list id="listVisita" name="LISTADOS DE VISITAS" description="Listado de visitas">
        <datatable>
            <column id="column_visita_id" headerText="Id. Visita" filtering="true" ordering="true" value="${entity.visita_id}">
                <filter property="visita_id" matching="contains" valueExpression="${this.column_visita_id}"/>
                <order property="visita_id"/>
            </column>
            <column id="column_visita" headerText="Visita" filtering="true" ordering="true" value="${entity.visita}">
                <filter property="visita" matching="contains" valueExpression="${this.column_visita}"/>
                <order property="visita"/>
            </column>
            <column id="recinto" headerText="Recinto" filtering="false" ordering="false" value="${entity.recinto.c_refrec}"/>
            <column id="position" headerText="Posición" filtering="false" ordering="false" value="${entity.position}"/>
            <action type="nav" route="idVisita-editVisita"/>
        </datatable>

        <buttonbar type="fab">
            <button id="createButton">
                <action id="createVisita" type="create" route="idVisita-editVisita">
                    <param name="repo" value="visitaRepo"/>
                    <param name="fecha_evaluacion" value="${date.now}"/>
                </action>
            </button>
        </buttonbar>

    </list>

    <edit id="editVisita">
        <script src="scripts/control.js"/>
        <form id="formVisita">

            <p value=""/>
            <p backgroundColor="#26a69a" fontSize="22" fontColor="#FFFFFF" bold="true" value="VISITA"/>
            <p value=""/>

            <table>
                <row>
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Exportar"/>
                </row>
                <row>
                    <table border="false">
                        <row weights="30, 20, 50">

                            <select id="job_id" label="Exportar: " >
                                <options>
                                    <option value="job_exportar_todas_visitas" label="Todas las visitas"/>
                                    <option value="job_exportar_visita" label="Visita"/>
                                    <option value="job_exportar_todos_transectos" label="Todos los transectos"/>
                                    <option value="job_exportar_transecto" label="Todos los transectos de la visita"/>
                                    <option value="job_exportar_todas_unidades_muestrales" label="Todas las unidade muestrales"/>
                                    <option value="job_exportar_unidades_muestrales" label="Todas las unidades muestrales de la visita"/>
                                </options>
                            </select>
                            <button label="Exportar" readonly="${empty (view.job_id)}" readonlyMessage="Debe indicar el tipo de exportación">
                                <action type="composite">
                                    <action type="save">
                                    </action>
                                    <action registerInHistory="false" type="job">
                                        <param name="jobId" value="${view.job_id}" />
                                        <param name="visita_id" value="${entity.visita_id}" />
                                        <param name="visita" value="${entity.visita}"/>
                                    </action>
                                </action>
                            </button>

                            <!--button label="Sincronizar">
                                <action>
                                    <action registerInHistory="false" type="job">
                                        <param name="jobId" value="gesinttop_sync_job_cmd" />
                                        <param name="resourceFilter" value="none"/>
                                    </action>
                                    <nav refresh="all"/>
                                </action>
                            </button-->
                        </row>
                    </table>
                </row>
           </table>

            <!--table border="true" >
                <row weights="15, 15, 15, 15, 15, 15">
                    <button label="Todas las visitas">
                        <action type="composite">
                            <action type="save">
                            </action>
                            <action registerInHistory="false" type="job">
                                <param name="jobId" value="job_exportar_todas_visitas" />
                            </action>
                        </action>
                    </button>
                    <button label="Visita">
                        <action type="composite">
                            <action type="save">
                            </action>
                            <action registerInHistory="false" type="job">
                                <param name="jobId" value="job_exportar_visita" />
                                <param name="visita_id" value="${entity.visita_id}" />
                                <param name="visita" value="${entity.visita}" />
                            </action>
                        </action>
                    </button>
                    <button label="Todos los transectos">
                        <action type="composite">
                            <action type="save">
                            </action>
                            <action registerInHistory="false" type="job">
                                <param name="jobId" value="job_exportar_todos_transectos" />
                            </action>
                        </action>
                    </button>
                    <button label="Transectos de la visita">
                        <action type="composite">
                            <action type="save">
                            </action>
                            <action registerInHistory="false" type="job">
                                <param name="jobId" value="job_exportar_transecto" />
                                <param name="visita_id" value="${entity.visita_id}" />
                                <param name="visita" value="${entity.visita}" />
                            </action>
                        </action>
                    </button>
                    <button label="Todas las uds. muestrales">
                        <action type="composite">
                            <action type="save">
                            </action>
                            <action registerInHistory="false" type="job">
                                <param name="jobId" value="job_exportar_todas_unidades_muestrales" />
                            </action>
                        </action>
                    </button>
                    <button label="Uds. muestrales de la visita">
                        <action type="composite">
                            <action type="save">
                            </action>
                            <action registerInHistory="false" type="job">
                                <param name="jobId" value="job_exportar_unidades_muestrales" />
                                <param name="visita_id" value="${entity.visita_id}" />
                                <param name="visita" value="${entity.visita}" />
                            </action>
                        </action>
                    </button>
                </row>
            </table-->


            <table>
                <row colspan="2">
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Visita"/>
                </row>
                <row>
                    <input id="visita_id" label="Id. visita: " readonly="true" placeHolder="${params.entityId}" value="${entity.visita_id}" />
                    <input id="visita" label="Visita: " value="${entity.visita}" validator="required">
                        <action type="composite">
                            <action type="save">
                            </action>
                            <action type="js" refresh="datatableTransectos">
                                <param name="method" value="updatePrefijoGPS" />
                            </action>
                        </action>
                    </input>
                    <input label="Localización: " value="${entity.position}" readonly="true"/>
                </row>
                <row>
                    <date id="fecha_evaluacion" label="Fecha evaluación: " value="${entity.fecha_evaluacion}"/>
                    <input label="Evaluador: " value="${entity.evaluador}"/>
                </row>
            </table>

            <table>
                <row>
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Recinto"/>
                </row>
                <row>
                    <autocomplete forceSelection="true" id="c_provincia_id" label="Provincia: " repo="provinciaRepo" value="${entity.recinto.provincia.c_provincia_id}">
                        <options labelExpression="${entity.d_provincia}" labelFilteringProperty="d_provincia" valueProperty="c_provincia_id" />
                    </autocomplete>
                    <autocomplete forceSelection="true" id="c_provmuni_id" label="Municipio: " repo="municipioRepo" value="${entity.recinto.municipio.c_provmuni_id}">
                        <options labelExpression="${entity.d_nombre}" labelFilteringProperty="d_nombre" valueProperty="c_provmuni_id" />
                        <repofilter>
                            <eq property="c_provincia_id" value="${view.c_provincia_id}" mandatory="true"/>
                            <contains property="d_nombre" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete forceSelection="true"  label="Recinto: " id="c_recinto_id" repo="recintoRepo" value="${entity.c_recinto_id}">
                        <options labelExpression="${entity.c_refrec}" labelFilteringProperty="c_refrec" valueProperty="c_recinto_id" />
                        <repofilter>
                            <eq property="c_provincia_id" value="${view.c_provincia_id}" mandatory="true"/>
                            <eq property="c_provmuni_id" value="${view.c_provmuni_id}" mandatory="true"/>
                            <contains property="c_refrec" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <!--row>
                    <input label="Agregado: " value="${view.c_recinto_id}" onBeforeRender="updateAgregado" readonly="true"/>
                    <input label="Zona: " value="${view.c_recinto_id}" onBeforeRender="updateZona" readonly="true"/>
                    <input label="Polígono: " value="${view.c_recinto_id}" onBeforeRender="updatePoligono" readonly="true"/>
                    <input label="Parcela: " value="${view.c_recinto_id}" onBeforeRender="updateParcela" readonly="true"/>
                    <input label="Recinto: " value="${view.c_recinto_id}" onBeforeRender="updateRecinto" readonly="true"/>
                </row-->
            </table>

            <table>
                <row colspan="3">
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Parcela"/>
                </row>
                <row>
                    <autocomplete label="Habitat: " forceSelection="true" id="c_habitat_id" repo="habitatRepo" value="${entity.c_habitat_id}">
                        <options labelExpression="${entity.d_habitat}" labelFilteringProperty="d_habitat" valueProperty="c_habitat_id" />
                        <repofilter>
                            <contains property="d_habitat" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Grupo producto: " forceSelection="true" id="c_grupoprod_id" repo="grupoProdRepo" value="${entity.c_grupoprod_id}">
                        <options labelExpression="${entity.d_grupoprod}" labelFilteringProperty="d_grupoprod" valueProperty="c_grupoprod_id" />
                        <repofilter>
                            <contains property="d_grupoprod" value="${this.value}"/>
                            <eq property="c_habitat_id" value="${view.c_habitat_id}" mandatory="true"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Producto: " forceSelection="true" id="c_producto_id" repo="productoRepo" value="${entity.c_producto_id}">
                        <options labelExpression="${entity.d_producto}" labelFilteringProperty="d_producto" valueProperty="c_producto_id" />
                        <repofilter>
                            <contains property="d_producto" value="${this.value}"/>
                            <eq property="c_habitat_id" value="${view.c_habitat_id}" mandatory="true"/>
                            <eq property="c_grupoprod_id" value="${view.c_grupoprod_id}" mandatory="true"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <row>
                    <autocomplete label="Sistema explotación: " forceSelection="true" id="c_sistema_explotacion_id" repo="sistemaExplotacionRepo" value="${entity.c_sistema_explotacion_id}">
                        <options labelExpression="${entity.d_sistema_explotacion}" labelFilteringProperty="d_sistema_explotacion" valueProperty="c_sistema_explotacion_id" />
                        <repofilter>
                            <contains property="d_sistema_explotacion" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Tipo laboreo: " forceSelection="true" id="c_tipo_laboreo_id" repo="tipoLaboreoRepo" value="${entity.c_tipo_laboreo_id}">
                        <options labelExpression="${entity.d_tipo_laboreo}" labelFilteringProperty="d_tipo_laboreo" valueProperty="c_tipo_laboreo_id" />
                        <repofilter>
                            <contains property="d_tipo_laboreo" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Tipo actuación parcela: " forceSelection="true" id="c_tipo_actuacion_parcela_id" repo="tipoActuacionParcelaRepo" value="${entity.c_tipo_actuacion_parcela_id}">
                        <options labelExpression="${entity.d_tipo_actuacion_parcela}" labelFilteringProperty="d_tipo_actuacion_parcela" valueProperty="c_tipo_actuacion_parcela_id" />
                        <repofilter>
                            <contains property="d_tipo_actuacion_parcela" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <row>
                    <autocomplete label="Altura cubierta: " forceSelection="true" id="c_altura_cubierta_parcela_id" repo="alturaCubiertaParcelaRepo" value="${entity.c_altura_cubierta_parcela_id}">
                        <options labelExpression="${entity.d_altura_cubierta_parcela}" labelFilteringProperty="d_altura_cubierta_parcela" valueProperty="c_altura_cubierta_parcela_id" />
                        <repofilter>
                            <contains property="d_altura_cubierta_parcela" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Densidad cubierta: " forceSelection="true" id="c_densidad_cubierta_parcela_id" repo="densidadCubiertaParcelaRepo" value="${entity.c_densidad_cubierta_parcela_id}">
                        <options labelExpression="${entity.d_densidad_cubierta_parcela}" labelFilteringProperty="d_densidad_cubierta_parcela" valueProperty="c_densidad_cubierta_parcela_id" />
                        <repofilter>
                            <contains property="d_densidad_cubierta_parcela" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Estado cubierta: " forceSelection="true" id="c_estado_cubierta_parcela_id" repo="estadoCubiertaParcelaRepo" value="${entity.c_estado_cubierta_parcela_id}">
                        <options labelExpression="${entity.d_estado_cubierta_parcela}" labelFilteringProperty="d_estado_cubierta_parcela" valueProperty="c_estado_cubierta_parcela_id" />
                        <repofilter>
                            <contains property="d_estado_cubierta_parcela" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <row>
                    <autocomplete label="Presencia leñosas parcela: " forceSelection="true" id="c_presencia_lenosas_parcela_id" repo="presenciaLenosasParcelaRepo" value="${entity.c_presencia_lenosas_parcela_id}">
                        <options labelExpression="${entity.d_presencia_lenosas_parcela}" labelFilteringProperty="d_presencia_lenosas_parcela" valueProperty="c_presencia_lenosas_parcela_id" />
                        <repofilter>
                            <contains property="d_presencia_lenosas_parcela" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Apreciación visual rodales topillo parcela: " forceSelection="true" id="c_apreciacion_visual_rodales_topillo_parcela_id" repo="apreciacionVisualRodalesTopilloParcelaRepo" value="${entity.c_apreciacion_visual_rodales_topillo_parcela_id}">
                        <options labelExpression="${entity.d_apreciacion_visual_rodales_topillo_parcela}" labelFilteringProperty="d_apreciacion_visual_rodales_topillo_parcela" valueProperty="c_apreciacion_visual_rodales_topillo_parcela_id" />
                        <repofilter>
                            <contains property="d_apreciacion_visual_rodales_topillo_parcela" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Porcentaje superficie rodales topillo parcela: " forceSelection="true" id="c_porcentaje_rodales_topillo_parcela_id" repo="porcentajeRodalesTopilloParcelaRepo" value="${entity.c_porcentaje_rodales_topillo_parcela_id}">
                        <options labelExpression="${entity.d_porcentaje_rodales_topillo_parcela}" labelFilteringProperty="d_porcentaje_rodales_topillo_parcela" valueProperty="c_porcentaje_rodales_topillo_parcela_id" />
                        <repofilter>
                            <contains property="d_porcentaje_rodales_topillo_parcela" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                 <row>
                    <textarea label="Observaciones parcela: " value="${entity.observaciones_parcela}"/>
                </row>
            </table>

            <table>
                <row>
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Linde"/>
                </row>
                <row>
                    <autocomplete label="Tipo linde: " forceSelection="true" id="c_tipo_linde_id" repo="tipoLindeRepo" value="${entity.c_tipo_linde_id}">
                        <options labelExpression="${entity.d_tipo_linde}" labelFilteringProperty="d_tipo_linde" valueProperty="c_tipo_linde_id" />
                        <repofilter>
                            <contains property="d_tipo_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <input label="Altura linde: " value="${entity.d_altura_linde}" inputType="3"/>
                    <input label="Anchura linde: " value="${entity.d_anchura_linde}" inputType="3"/>
                    <autocomplete label="Tipo actuación linde: " forceSelection="true" id="c_tipo_actuacion_linde_id" repo="tipoActuacionLindeRepo" value="${entity.c_tipo_actuacion_linde_id}">
                        <options labelExpression="${entity.d_tipo_actuacion_linde}" labelFilteringProperty="d_tipo_actuacion_linde" valueProperty="c_tipo_actuacion_linde_id" />
                        <repofilter>
                            <contains property="d_tipo_actuacion_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <row>
                    <autocomplete label="Altura cubierta: " forceSelection="true" id="c_altura_cubierta_linde_id" repo="alturaCubiertaLindeRepo" value="${entity.c_altura_cubierta_linde_id}">
                        <options labelExpression="${entity.d_altura_cubierta_linde}" labelFilteringProperty="d_altura_cubierta_linde" valueProperty="c_altura_cubierta_linde_id" />
                        <repofilter>
                            <contains property="d_altura_cubierta_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Densidad cubierta: " forceSelection="true" id="c_densidad_cubierta_linde_id" repo="densidadCubiertaLindeRepo" value="${entity.c_densidad_cubierta_linde_id}">
                        <options labelExpression="${entity.d_densidad_cubierta_linde}" labelFilteringProperty="d_densidad_cubierta_linde" valueProperty="c_densidad_cubierta_linde_id" />
                        <repofilter>
                            <contains property="d_densidad_cubierta_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Estado cubierta: " forceSelection="true" id="c_estado_cubierta_linde_id" repo="estadoCubiertaLindeRepo" value="${entity.c_estado_cubierta_linde_id}">
                        <options labelExpression="${entity.d_estado_cubierta_linde}" labelFilteringProperty="d_estado_cubierta_linde" valueProperty="c_estado_cubierta_linde_id" />
                        <repofilter>
                            <contains property="d_estado_cubierta_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <row>
                    <autocomplete label="Presencia leñosas linde: " forceSelection="true" id="c_presencia_lenosas_linde_id" repo="presenciaLenosasLindeRepo" value="${entity.c_presencia_lenosas_linde_id}">
                        <options labelExpression="${entity.d_presencia_lenosas_linde}" labelFilteringProperty="d_presencia_lenosas_linde" valueProperty="c_presencia_lenosas_linde_id" />
                        <repofilter>
                            <contains property="d_presencia_lenosas_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Apreciación visual rodales topillo linde: " forceSelection="true" id="c_apreciacion_visual_rodales_topillo_linde_id" repo="apreciacionVisualRodalesTopilloLindeRepo" value="${entity.c_apreciacion_visual_rodales_topillo_linde_id}">
                        <options labelExpression="${entity.d_apreciacion_visual_rodales_topillo_linde}" labelFilteringProperty="d_apreciacion_visual_rodales_topillo_linde" valueProperty="c_apreciacion_visual_rodales_topillo_linde_id" />
                        <repofilter>
                            <contains property="d_apreciacion_visual_rodales_topillo_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                    <autocomplete label="Porcentaje superficie rodales topillo linde: " forceSelection="true" id="c_porcentaje_rodales_topillo_linde_id" repo="porcentajeRodalesTopilloLindeRepo" value="${entity.c_porcentaje_rodales_topillo_linde_id}">
                        <options labelExpression="${entity.d_porcentaje_rodales_topillo_linde}" labelFilteringProperty="d_porcentaje_rodales_topillo_linde" valueProperty="c_porcentaje_rodales_topillo_linde_id" />
                        <repofilter>
                            <contains property="d_porcentaje_rodales_topillo_linde" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <row>
                    <textarea label="Observaciones linde: " value="${entity.observaciones_linde}"/>
                </row>
            </table>

           <table>
                <row>
                    <p backgroundColor="#26a69a" fontSize="18" fontColor="#FFFFFF" bold="true" value=" Transecto"/>
                </row>
                <row>
                    <table border="false">
                        <row>
                            <autocomplete label="Tipo transecto: " forceSelection="true" id="tipo_transecto_id" repo="tipoTransectoRepo" allowsPartialRestore="false">
                                <options labelExpression="${entity.tipo_transecto}" labelFilteringProperty="tipo_transecto" valueProperty="tipo_transecto_id" />
                                <repofilter>
                                    <contains property="tipo_transecto" value="${this.value}"/>
                                </repofilter>
                            </autocomplete>
                            <input label="Nº transecto: " id="num_transecto" inputType="3" allowsPartialRestore="false"/>
                            <input label="Nº uds. muestrales: " id="num_unidades_muestrales_transecto" inputType="3" allowsPartialRestore="false"/>
                            <button label="AÑADIR TRANSECTO"  readonly="${empty (view.tipo_transecto_id) or empty(view.num_unidades_muestrales_transecto) or empty(view.num_transecto)}" readonlyMessage="Debe indicar los datos del transecto">
                                    <action id="compositeAction">
                                        <action id="saveVisita" type="save">
                                        </action>
                                        <action id="createTransecto" type="js" refresh="datatableTransectos">
                                            <param name="method" value="createTransecto" />
                                            <param name="entityId" value="${view.visita_id}"/>
                                            <param name="tipo_transecto_id" value="${view.tipo_transecto_id}" />
                                            <param name="num_unidades_muestrales_transecto" value="${view.num_unidades_muestrales_transecto}" />
                                            <param name="num_transecto" value="${view.num_transecto}" />
                                            <param name="visita" value="${view.visita}" />
                                       </action>

                                    </action>
                            </button>
                        </row>
                        <row>
                            <datatable
                                id="datatableTransectos"
                                allowsPartialRestore="false"
                                numVisibleRows="3"
                                repo="transectoRepo"
                                route="idTransecto-editTransecto"
                                onBeforeRender="setTrabajoRealizado">
                                <column id="column_num_transecto" headerText="Nº transecto" filtering="false" ordering="false" value="${entity.num_transecto}"/>
                                <column id="column_transecto" headerText="Tipo transecto" filtering="false" ordering="false" value="${entity.tipoTransecto.tipo_transecto}"/>
                                <column id="column_num_unidades_muestrales_transecto" headerText="Nº. uds. muestrales" filtering="false" ordering="false" value="${entity.num_unidades_muestrales_transecto}"/>
                                <column id="column_prefijo_gps" headerText="Prefijo GPS" filtering="false" ordering="false" value="${entity.prefijo_gps}"/>
                                <column id="column_trabajo_realizado" headerText="Trabajo realizado" filtering="false" ordering="false" value="${entity.trabajo_realizado}"/>
                                <repofilter>
                                    <eq property="visita_id" value="${empty(entity.visita_id) ? '-1' : entity.visita_id}" />
                                </repofilter>
                            </datatable>
                        </row>
                    </table>
                </row>☻
            </table>

        </form>

        <buttonbar type="bottom">
            <button label="Save">
                <action route="idVisita-listVisita" type="save" registerInHistory="false" popHistory="1"/>
            </button>
            <button label="Cancel" route="back"/>
            <button label="Delete" readonly="${empty (entity.visita_id)}" readonlyMessage="No puede realizar esta acción: No existe visita" restoreView="true" confirmation="true" labelConfirmation="Se va a eliminar la visita. ¿Desea continuar?">
                <!--action type="js" route="back" registerInHistory="false">
                    <param name="method" value="deleteVisita" />
                    <param name="transectoId" value="${entity.visita_id}" />
                </action-->
                <action type="delete" route="back" registerInHistory="false">
                </action>
            </button>
        </buttonbar>
    </edit>
</main>
