{
  "description": "Sincronizaci√≥n de tareas",
  "globalParams": {
    "endpoint": "https://serviciosprex.itacyl.es/crtchk10/cnt/rest/syncro/",
    "wksId": "operadoresvino",
    "wksUser": "${params.userId}",
    "wksPwd": "operadoresvino",
    "destTmpFolder": "${app.workingFolder}/${random:string()}"
  },
  "tasks": [
    {
      "name": "t0",
      "description": "Compressing database",
      "processor": {
        "type": "FileCmdProcessor",
        "commands": [
          "zip ${app.workingFolder}/file1.zip ${project.dataFolder}/controloperadoresvino.sqlite",
          "mkdir ${gparams.destTmpFolder}"
        ]
      }
    },
    {
      "name": "t1",
      "description": "Starting synchronization",
      "processor": {
        "type": "httpRequestProcessor",
        "method": "post",
        "contentType": "multipart/form-data",
        "inputFile": "${app.workingFolder}/file1.zip",
        "inputFileName": "clientDB.sqlite",
        "url": "${gparams.endpoint}",
        "headers": {
          "wks": "${gparams.wksId}",
          "user": "${gparams.wksUser}",
          "password": "${gparams.wksPwd}"
        }
      }
    },
    {
      "name": "g1",
      "iterSize": 10,
      "iterDelay": 3000,
      "description": "Checking synchronization state",
      "exitLoopExpression": "${g1.output.contains('FINISHED') || g1.output.contains('ERROR')}",
      "tasks": [
        {
          "name": "t2",
          "description": "Checking synchronization state",
          "processor": {
            "type": "httpRequestProcessor",
            "method": "get",
            "url": "${t1.responseHeaders['Location']}",
            "headers": {
              "wks": "${gparams.wksId}",
              "user": "${gparams.wksUser}",
              "password": "${gparams.wksPwd}"
            },
            "outputContext": "g1"
          }
        }
      ]
    },
    {
      "name": "t3",
      "description": "Checking sync process result",
      "processor": {
        "type": "ConditionalStopProcessor",
        "expression": "g1.output.contains('ERROR')",
        "message": "The sync process ended with an error, check log for details."
      }
    },
    {
      "name": "t4",
      "description": "Downloading file",
      "processor": {
        "type": "httpRequestProcessor",
        "method": "get",
        "contentType": "application/octet-stream",
        "url": "${t1.responseHeaders['Location'].replace('syncro','syncroFile')}",
        "headers": {
          "wks": "${gparams.wksId}",
          "user": "${gparams.wksUser}",
          "password": "${gparams.wksPwd}"
        },
        "outputFileExtension": "zip"
      }
    },
    {
      "name": "t5",
      "description": "Updating sync state",
      "processor": {
        "type": "httpRequestProcessor",
        "method": "put",
        "contentType": "application/json",
        "url": "${t1.responseHeaders['Location']}",
        "headers": {
          "wks": "${gparams.wksId}",
          "user": "${gparams.wksUser}",
          "password": "${gparams.wksPwd}"
        },
        "body": "{}"
      }
    },
    {
      "name": "t6",
      "description": "Unzipping downloaded database file",
      "processor": {
        "type": "FileCmdProcessor",
        "commands": [
          "unzip ${t4.outputFile} ${gparams.destTmpFolder}",
          "copy ${project.dataFolder}/controloperadoresvino.sqlite ${project.dataFolder}/controloperadoresvino_backup.sqlite",
          "copy ${gparams.destTmpFolder}/controloperadoresvino.sqlite ${project.dataFolder}/controloperadoresvino.sqlite"
        ]
      }
    },
    {
      "name": "t7",
      "description": "Publishing database file",
      "processor": {
        "type": "ContextPopulateProcessor",
        "name": "outputFile",
        "value": "${project.dataFolder}/controloperadoresvino.sqlite"
      }
    },
    {
      "name": "t99",
      "processor": {
        "type": "ContextDebugProcessor",
        "output": "console"
      }
    }
  ]
}