<main id="controlInSitu" name="Control in situ" repo="actasControlRepo">
    <list id="listInSitu" name=" CONTROL IN SITU">
        <datatable>
            <column id="column_id" headerText="Id Exp." filtering="true" ordering="true" value="${entity.id}">
                <filter property="id" matching="contains" valueExpression="${this.column_id}"/>
                <order property="id"/>
            </column>
            <column id="column_num_expediente" headerText="Nº Exp." filtering="true" ordering="true" value="${entity.num_expediente}">
                <filter property="num_expediente" matching="contains" valueExpression="${this.column_num_expediente}"/>
                <order property="num_expediente"/>
            </column>
            <column id="column_razon_social" headerText="Razón social" filtering="false" ordering="false" value="${entity.operador.razon_social}"/>
            <column id="column_fecha" headerText="Fecha" filtering="true" ordering="true" value="${entity.fecha}">
                <filter property="fecha" matching="contains" valueExpression="${this.column_fecha}"/>
                <order property="fecha"/>
            </column>
            <action type="nav" route="controlInSitu-editInSitu"/>
        </datatable>

        <buttonbar type="fab">
            <button id="createButton">
                <action id="createExpediente" type="create" route="controlInSitu-editInSitu" >
                    <param name="repo" value="actasControlRepo"/>
                    <param name="fecha" value="${date.now}"/>
                </action>
            </button>
        </buttonbar>

    </list>
    <edit id="editInSitu">
        <script src="scripts/controlLote.js"/>
        <form>

            <p value=""/>
            <p backgroundColor="#26a69a" fontSize="22" fontColor="#FFFFFF" bold="true" value="CONTROL IN SITU"/>

            <table border="false">
                <row>
                    <button label="Generar Acta Control" render="${not empty(entity.id)}">
                        <action id="compositeAction">
                            <action id="saveVisita" type="save">
                            </action>
                            <action registerInHistory="false" type="job">
                                <param name="jobId" value="job_generar_acta_control" />
                                <param name="expediente_id" value="${entity.id}"/>
                            </action>
                        </action>
                    </button>
                    <button label="Cuestionario">
                        <action type="save" route="idCuestionarioControlInSitu-editCuestionarioControlInSitu">
                            <param name="expediente_id" value="${entity.id}"/>
                            <param name="num_expediente" value="${view.num_expediente}"/>
                            <param name="operador_id" value="${view.operador_id}"/>
                            <param name="instalacion_id" value="${view.instalacion}"/>
                        </action>
                    </button>
                </row>
            </table>

          <table>
                <row>
                    <input label="Id. expediente: " id="expediente_id" readonly="true" placeHolder="${params.entityId}" value="${entity.id}"/>
                    <input id="num_expediente" label="Nº Expediente: " value="${entity.num_expediente}" validator="required"/>
                    <date label="Fecha:           " value="${entity.fecha}"  validator="required"/>
                 </row>
            </table>

            <table weights="67, 33">
                <row border="false">
                    <autocomplete id="operador_id" label="Operador: " forceSelection="true" repo="operadorRepo" value="${entity.operador_id}" validator="required">
                        <options labelExpression="${entity.razon_social}" labelFilteringProperty="razon_social" valueProperty="operador_id" />
                        <repofilter>
                            <contains property="razon_social" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>

                    <button label="Añadir operador" readonly="${empty (entity.id)}" readonlyMessage="No puede añadir un operador. Antes debe guardar el expediente">
                        <action type="save" route="operador-editOperadores">
                            <param name="expediente_id" value="${entity.id}" />
                        </action>
                    </button>
                </row>
                <row>
                    <autocomplete id="instalacion" label="Instalación: " forceSelection="true" repo="instalacionRepo" value="${entity.instalacion_id}" validator="required">
                        <options labelExpression="${entity.nombre_instalacion}" labelFilteringProperty="nombre_instalacion" valueProperty="instalacion_id" />
                        <repofilter>
                            <eq property="operador_id" value="${view.operador_id}" mandatory="true"/>
                            <contains property="nombre_instalacion" value="${this.value}"/>
                        </repofilter>
                    </autocomplete>
                </row>
                <row>
                    <input id="representante" label="Representante operador en la auditoria: " value="${entity.auditado}" />
                </row>
                <row>
                    <input label="Cargo del representante operador en la auditoria: " value="${entity.cargo_representante}" />
                </row>
            </table>

            <table>
                <row>
                    <select id="auditor" label="Auditor: " value="${entity.auditor}" >
                        <options>
                            <option value="Teresa Yañez Colomo" label="Teresa Yañez Colomo"/>
                            <option value="Emilio Rodrigo Ramos" label="Emilio Rodrigo Ramos" />
                            <option value="José Ignacio Marqués Rodríguez" label="José Ignacio Marqués Rodríguez" />
                            <option value="Cristina Rebollo Acebes" label="Cristina Rebollo Acebes" />
                            <option value="Inmaculada Sáez González" label="Inmaculada Sáez González" />
                            <option value="Irene Lara Hergueras" label="Irene Lara Hergueras" />
                            <option value="Jesús Durán Martín" label="Jesús Durán Martín" />
                            <option value="Juan Carlos González Ruíz" label="Juan Carlos González Ruíz" />
                            <option value="Mª Montserrat Gil Pérez" label="Mª Montserrat Gil Pérez" />
                            <option value="Manuel Fernández Calderón" label="Manuel Fernández Calderón" />
                            <option value="Maria del Carmen Melendre Frías" label="Maria del Carmen Melendre Frías" />
                            <option value="Marta Martín Álvarez" label="Marta Martín Álvarez" />
                            <option value="Ruth Franco Fernández" label="Ruth Franco Fernández" />
                            <option value="Sátur Jiménez Andrés" label="Sátur Jiménez Andrés" />
                            <option value="Óscar Díez Sánchez" label="Óscar Díez Sánchez" />
                        </options>
                    </select>
                </row>
            </table>
            <table>
                <row>
                    <textarea id="auditor2" label="Otros auditor: " value="${entity.auditor2}" />
                </row>
            </table>

            <table>
                <row>
                    <textarea label="Notas aclaratorias" value="${entity.notas_aclaratorias_datos_generales}" lines="3"/>
                </row>
             </table>

            <table>
                <row>
                    <table border="false">
                        <row>
                            <p bold="true" value="Principales hallazgos detactados tras el control: "/>
                        </row>

                        <row>
                            <datatable
                                allowsPartialRestore="false"
                                id="datatableDesviaciones"
                                numVisibleRows="6"
                                repo="desviacionRepo"
                                route="desviacion-editDesviacion"
                                onBeforeRender="updateDatatableDesviaciones">
                                <column id="column_descripcion_apartado" headerText="Apartado" filtering="true" ordering="true" value="${entity.descripcion_apartado}">
                                    <filter property="descripcion_apartado" matching="contains" valueExpression="${this.column_descripcion_apartado}"/>
                                    <order property="orden"/>
                                </column>
                                <column id="column_requisito" headerText="Requisito" filtering="true" ordering="true" value="${entity.requisito}">
                                    <filter property="requisito" matching="contains" valueExpression="${this.column_requisito}"/>
                                    <order property="requisito"/>
                                </column>
                                <column id="column_hallazgo" headerText="Hallazgo" filtering="true" ordering="true" value="${entity.hallazgo}">
                                    <filter property="hallazgo" matching="contains" valueExpression="${this.column_hallazgo}"/>
                                    <order property="hallazgo"/>
                                </column>
                                <repofilter>
                                    <and>
                                        <eq property="expediente_id" value="${empty(entity.id) ? '-1' : entity.id}" />
                                        <eq property="cumple" value="N" />
                                    </and>
                                </repofilter>
                            </datatable>
                        </row>
                    </table>
                </row>
            </table>
            <table>
                <row>
                    <textarea label="Alegaciones del auditado: " value="${entity.alegaciones_auditado}" lines="3" />
                </row>
            </table>

            <table>
                <row weights="67, 33">
                    <date label="A los efectos oportunos, subscriben el presente documento, por lo que firman: " value="${entity.fecha_firma}" hasButtonToday="true"/>
                    <radio label="Conforme: " value="${entity.conforme}" orientation="horizontal">
                        <options>
                            <option label="SI" value="SI" />
                            <option label="NO" value="NO" />
                        </options>
                    </radio>
                </row>
                <row weights="33, 34, 33">
                    <table border="false">
                        <row>
                            <p bold="true" value="Auditor"/>
                        </row>
                        <row>
                            <image converter="b64Image" embedded="true" value="${entity.firma_auditor}" hasDeleteButton="false" inputType="4"/>
                        </row>
                        <row>
                            <input label="Fdo." value="${view.auditor}" readonly="true"/>
                        </row>
                    </table>
                    <table border="false">
                        <row>
                            <p bold="true" value="Auditor 2"/>
                        </row>
                        <row>
                            <image converter="b64Image" embedded="true" value="${entity.firma_auditor2}" hasDeleteButton="false" inputType="4"/>
                        </row>
                        <row>
                            <input label="Fdo." value="${view.auditor2}" readonly="true"/>
                        </row>
                    </table>
                    <table border="false">
                        <row>
                            <p bold="true" value="Auditados"/>
                        </row>
                        <row>
                            <image converter="b64Image" embedded="true" value="${entity.firma_auditado}" hasDeleteButton="false" inputType="4"/>
                        </row>
                        <row>
                            <input label="Fdo." value="${view.representante}" readonly="true"/>
                        </row>
                    </table>
                </row>
            </table>

        </form>
        <buttonbar type="bottom">
            <button label="Save">
                <action route="controlInSitu-listInSitu" type="save" registerInHistory="false" popHistory="1"/>
            </button>
            <button label="Cancel">
                <action type="cancel" route="back"/>
            </button>
        </buttonbar>
    </edit>
</main>
